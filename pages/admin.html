<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Pustakalayah LibraryHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="../styles.css">
</head>
<body class="font-sans bg-gray-50">
  
  <!-- Navigation -->
  <nav class="bg-indigo-700 text-white p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <img src="../logo.jpg" alt="Logo" class="h-10 w-auto rounded-lg">
        <h1 class="text-2xl font-bold">Admin Panel</h1>
      </div>
      <div class="flex space-x-4">
        <button onclick="window.location.href='dashboard.html'" class="bg-white text-indigo-700 px-4 py-2 rounded-lg hover:bg-gray-100 transition">Back to Dashboard</button>
        <button id="logoutBtn" class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700 transition">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto p-6">
    
    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-300">
      <div class="flex space-x-4">
        <button id="booksTab" class="px-6 py-3 font-semibold border-b-2 border-indigo-600 text-indigo-600">Books Management</button>
        <button id="usersTab" class="px-6 py-3 font-semibold text-gray-600 hover:text-indigo-600">Users Management</button>
      </div>
    </div>

    <!-- Books Management Section -->
    <div id="booksSection" class="space-y-6">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4 text-indigo-700">Add New Book</h2>
        <form id="addBookForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="text" id="bookTitle" placeholder="Book Title" class="border border-gray-300 p-3 rounded-lg" required>
          <input type="text" id="bookAuthor" placeholder="Author" class="border border-gray-300 p-3 rounded-lg" required>
          <select id="bookCategory" class="border border-gray-300 p-3 rounded-lg" required>
            <option value="">Select Category</option>
            <option value="fiction">Fiction</option>
            <option value="action">Action</option>
            <option value="romance">Romance</option>
            <option value="comic">Comic</option>
            <option value="mystery">Mystery</option>
          </select>
          <input type="text" id="bookISBN" placeholder="ISBN (optional)" class="border border-gray-300 p-3 rounded-lg">
          <input type="number" id="bookYear" placeholder="Published Year (optional)" class="border border-gray-300 p-3 rounded-lg">
          <input type="url" id="bookImage" placeholder="Image URL (optional)" class="border border-gray-300 p-3 rounded-lg">
          <textarea id="bookDescription" placeholder="Description (optional)" class="border border-gray-300 p-3 rounded-lg col-span-2" rows="3"></textarea>
          <button type="submit" class="col-span-2 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition">Add Book</button>
        </form>
      </div>

      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4 text-indigo-700">All Books</h2>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3 text-left">ID</th>
                <th class="p-3 text-left">Title</th>
                <th class="p-3 text-left">Author</th>
                <th class="p-3 text-left">Category</th>
                <th class="p-3 text-left">Available</th>
                <th class="p-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="booksTableBody">
              <!-- Books will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Users Management Section -->
    <div id="usersSection" class="space-y-6 hidden">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-4 text-indigo-700">All Users</h2>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3 text-left">ID</th>
                <th class="p-3 text-left">Username</th>
                <th class="p-3 text-left">Email</th>
                <th class="p-3 text-left">Role</th>
                <th class="p-3 text-left">Email Verified</th>
                <th class="p-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Users will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Edit Book Modal -->
  <div id="editBookModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-2xl max-w-2xl w-full mx-4">
      <h2 class="text-2xl font-bold mb-4 text-indigo-700">Edit Book</h2>
      <form id="editBookForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="editBookId">
        <input type="text" id="editBookTitle" placeholder="Book Title" class="border border-gray-300 p-3 rounded-lg" required>
        <input type="text" id="editBookAuthor" placeholder="Author" class="border border-gray-300 p-3 rounded-lg" required>
        <select id="editBookCategory" class="border border-gray-300 p-3 rounded-lg" required>
          <option value="fiction">Fiction</option>
          <option value="action">Action</option>
          <option value="romance">Romance</option>
          <option value="comic">Comic</option>
          <option value="mystery">Mystery</option>
        </select>
        <input type="text" id="editBookISBN" placeholder="ISBN" class="border border-gray-300 p-3 rounded-lg">
        <input type="number" id="editBookYear" placeholder="Published Year" class="border border-gray-300 p-3 rounded-lg">
        <input type="url" id="editBookImage" placeholder="Image URL" class="border border-gray-300 p-3 rounded-lg">
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="editBookAvailable" class="w-5 h-5">
          <label for="editBookAvailable">Available</label>
        </div>
        <textarea id="editBookDescription" placeholder="Description" class="border border-gray-300 p-3 rounded-lg col-span-2" rows="3"></textarea>
        <div class="col-span-2 flex space-x-4">
          <button type="submit" class="flex-1 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
          <button type="button" onclick="closeEditBookModal()" class="flex-1 bg-gray-400 text-white p-3 rounded-lg hover:bg-gray-500 transition">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script src="../script.js"></script>
  <script>
    // Check if user is admin
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!user || user.role !== 'admin') {
      alert('Access denied. Admin only.');
      window.location.href = 'dashboard.html';
    }

    const API_BASE = 'http://localhost:8000';

    // Tab switching
    document.getElementById('booksTab').addEventListener('click', () => {
      document.getElementById('booksSection').classList.remove('hidden');
      document.getElementById('usersSection').classList.add('hidden');
      document.getElementById('booksTab').classList.add('border-b-2', 'border-indigo-600', 'text-indigo-600');
      document.getElementById('booksTab').classList.remove('text-gray-600');
      document.getElementById('usersTab').classList.remove('border-b-2', 'border-indigo-600', 'text-indigo-600');
      document.getElementById('usersTab').classList.add('text-gray-600');
    });

    document.getElementById('usersTab').addEventListener('click', () => {
      document.getElementById('usersSection').classList.remove('hidden');
      document.getElementById('booksSection').classList.add('hidden');
      document.getElementById('usersTab').classList.add('border-b-2', 'border-indigo-600', 'text-indigo-600');
      document.getElementById('usersTab').classList.remove('text-gray-600');
      document.getElementById('booksTab').classList.remove('border-b-2', 'border-indigo-600', 'text-indigo-600');
      document.getElementById('booksTab').classList.add('text-gray-600');
      loadUsers();
    });

    // Load books
    async function loadBooks() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/api/books`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const books = await response.json();
        
        const tbody = document.getElementById('booksTableBody');
        tbody.innerHTML = books.map(book => `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-3">${book.id}</td>
            <td class="p-3">${book.title}</td>
            <td class="p-3">${book.author}</td>
            <td class="p-3"><span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded">${book.category}</span></td>
            <td class="p-3">${book.available ? '<span class="text-green-600">✓ Yes</span>' : '<span class="text-red-600">✗ No</span>'}</td>
            <td class="p-3">
              <button onclick="editBook(${book.id})" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 mr-2">Edit</button>
              <button onclick="deleteBook(${book.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading books:', error);
        alert('Failed to load books');
      }
    }

    // Add book
    document.getElementById('addBookForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const token = localStorage.getItem('token');
        const bookData = {
          title: document.getElementById('bookTitle').value,
          author: document.getElementById('bookAuthor').value,
          category: document.getElementById('bookCategory').value,
          isbn: document.getElementById('bookISBN').value || null,
          published_year: document.getElementById('bookYear').value ? parseInt(document.getElementById('bookYear').value) : null,
          image: document.getElementById('bookImage').value || null,
          description: document.getElementById('bookDescription').value || null,
          available: true
        };

        const response = await fetch(`${API_BASE}/api/books`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(bookData)
        });

        if (response.ok) {
          alert('Book added successfully!');
          document.getElementById('addBookForm').reset();
          loadBooks();
        } else {
          const error = await response.json();
          alert('Failed to add book: ' + (error.detail || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error adding book:', error);
        alert('Failed to add book');
      }
    });

    // Edit book
    async function editBook(id) {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/api/books/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const book = await response.json();

        document.getElementById('editBookId').value = book.id;
        document.getElementById('editBookTitle').value = book.title;
        document.getElementById('editBookAuthor').value = book.author;
        document.getElementById('editBookCategory').value = book.category;
        document.getElementById('editBookISBN').value = book.isbn || '';
        document.getElementById('editBookYear').value = book.published_year || '';
        document.getElementById('editBookImage').value = book.image || '';
        document.getElementById('editBookDescription').value = book.description || '';
        document.getElementById('editBookAvailable').checked = book.available;

        document.getElementById('editBookModal').classList.remove('hidden');
      } catch (error) {
        console.error('Error loading book:', error);
        alert('Failed to load book details');
      }
    }

    function closeEditBookModal() {
      document.getElementById('editBookModal').classList.add('hidden');
    }

    // Save edited book
    document.getElementById('editBookForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const token = localStorage.getItem('token');
        const id = document.getElementById('editBookId').value;
        const bookData = {
          title: document.getElementById('editBookTitle').value,
          author: document.getElementById('editBookAuthor').value,
          category: document.getElementById('editBookCategory').value,
          isbn: document.getElementById('editBookISBN').value || null,
          published_year: document.getElementById('editBookYear').value ? parseInt(document.getElementById('editBookYear').value) : null,
          image: document.getElementById('editBookImage').value || null,
          description: document.getElementById('editBookDescription').value || null,
          available: document.getElementById('editBookAvailable').checked
        };

        const response = await fetch(`${API_BASE}/api/books/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(bookData)
        });

        if (response.ok) {
          alert('Book updated successfully!');
          closeEditBookModal();
          loadBooks();
        } else {
          const error = await response.json();
          alert('Failed to update book: ' + (error.detail || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error updating book:', error);
        alert('Failed to update book');
      }
    });

    // Delete book
    async function deleteBook(id) {
      if (!confirm('Are you sure you want to delete this book?')) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/api/books/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          alert('Book deleted successfully!');
          loadBooks();
        } else {
          alert('Failed to delete book');
        }
      } catch (error) {
        console.error('Error deleting book:', error);
        alert('Failed to delete book');
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/api/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await response.json();
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = users.map(user => `
          <tr class="border-b hover:bg-gray-50">
            <td class="p-3">${user.id}</td>
            <td class="p-3">${user.username}</td>
            <td class="p-3">${user.email}</td>
            <td class="p-3"><span class="px-2 py-1 ${user.role === 'admin' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'} rounded">${user.role}</span></td>
            <td class="p-3">${user.email_verified ? '<span class="text-green-600">✓ Yes</span>' : '<span class="text-yellow-600">⚠ No</span>'}</td>
            <td class="p-3">
              ${user.role !== 'admin' ? `<button onclick="deleteUser(${user.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Delete</button>` : '<span class="text-gray-400">Protected</span>'}
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading users:', error);
        alert('Failed to load users');
      }
    }

    // Delete user
    async function deleteUser(id) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE}/api/users/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          alert('User deleted successfully!');
          loadUsers();
        } else {
          alert('Failed to delete user');
        }
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('Failed to delete user');
      }
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    });

    // Initial load
    loadBooks();
  </script>
</body>
</html>
